# التوثيق التقني لنظام معاينة متطلبات الدفاع المدني

## 1. نظرة عامة على النظام

### 1.1 المكونات الرئيسية
- **الخادم**: Node.js + Express.js
- **قاعدة البيانات**: SQLite
- **المصادقة**: JWT + CSRF Protection
- **معالجة الملفات**: Multer + Custom Validation
- **التشفير**: AES-256-GCM
- **النسخ الاحتياطي**: نظام مخصص للنسخ والاستعادة

### 1.2 المتطلبات التقنية
- Node.js v14 أو أحدث
- SQLite 3
- مساحة تخزين كافية للملفات والنسخ الاحتياطية
- ذاكرة RAM: 2GB على الأقل

## 2. هيكل قاعدة البيانات

### 2.1 الجداول الرئيسية
1. **users**: معلومات المستخدمين
   - `id`: INTEGER PRIMARY KEY
   - `username`: TEXT UNIQUE
   - `password`: TEXT (مشفر)
   - `role`: TEXT
   - `token_version`: INTEGER
   - `last_login`: TIMESTAMP

2. **forms**: النماذج الرئيسية
   - `id`: INTEGER PRIMARY KEY
   - `file_no`: TEXT (مشفر)
   - `reference_no`: TEXT (مشفر)
   - `occupancy_name`: TEXT (مشفر)
   - `status`: TEXT
   - حقول إضافية للمعلومات العامة

3. **addresses**: العناوين
   - `id`: INTEGER PRIMARY KEY
   - `form_id`: INTEGER FOREIGN KEY
   - حقول العنوان (مشفرة)

4. **photos**: الصور
   - `id`: INTEGER PRIMARY KEY
   - `form_id`: INTEGER FOREIGN KEY
   - `file_path`: TEXT
   - `hash`: TEXT
   - `metadata`: TEXT

### 2.2 الفهارس
- `idx_users_username`: تحسين البحث عن المستخدمين
- `idx_forms_status`: تحسين تصفية النماذج
- `idx_forms_dates`: تحسين البحث بالتواريخ
- `idx_photos_form`: تحسين استرجاع الصور

## 3. واجهات البرمجة (API)

### 3.1 المصادقة
```
POST /api/auth/register
POST /api/auth/login
POST /api/auth/refresh
POST /api/auth/logout
GET /api/csrf-token
```

### 3.2 إدارة النماذج
```
GET /api/forms
GET /api/forms/:id
POST /api/forms/draft
POST /api/forms/submit
DELETE /api/forms/:id
```

### 3.3 إدارة الصور
```
POST /api/forms/:id/photos
```

### 3.4 إدارة المتطلبات المخصصة
```
PUT /api/forms/:id/custom-requirements/reorder
```

## 4. آليات الأمان

### 4.1 المصادقة والتفويض
- نظام JWT ثنائي (Access Token + Refresh Token)
- حماية CSRF لجميع طلبات POST/PUT/DELETE
- تتبع إصدارات الرمز المميز
- تسجيل الخروج من جميع الأجهزة

### 4.2 تشفير البيانات
- تشفير البيانات الحساسة في قاعدة البيانات
- تشفير النسخ الاحتياطية
- تشفير المعلومات الشخصية والوثائق

### 4.3 التحقق من الملفات
- فحص نوع وحجم الملف
- التحقق من سلامة الصور
- حساب وتخزين البصمة الرقمية
- تنظيف أسماء الملفات

### 4.4 حماية عامة
- Rate Limiting لمنع هجمات DDoS
- Headers أمان باستخدام Helmet
- تسجيل الأحداث الأمنية

## 5. النسخ الاحتياطي

### 5.1 النسخ التلقائي
- جدولة النسخ كل 24 ساعة
- تشفير النسخ الاحتياطية
- حفظ البيانات الوصفية
- تنظيف النسخ القديمة

### 5.2 الاستعادة
- التحقق من سلامة النسخة
- فك تشفير البيانات
- استعادة تدريجية
- نسخ احتياطي للحالة الحالية

## 6. الاختبارات

### 6.1 اختبارات الوحدة
- اختبارات مدير التشفير
- اختبارات التحقق من الملفات
- اختبارات النسخ الاحتياطي

### 6.2 اختبارات التكامل
- اختبارات النقاط النهائية للنماذج
- اختبارات المصادقة
- اختبارات رفع الملفات

## 7. الأداء والتحسينات

### 7.1 تحسينات قاعدة البيانات
- استخدام الاستعلامات المجهزة
- تنفيذ عمليات الإدراج المجمعة
- فهارس للحقول المستخدمة بكثرة

### 7.2 تحسينات الذاكرة
- إدارة الملفات المؤقتة
- تنظيف الذاكرة المؤقتة
- معالجة التسريبات المحتملة

## 8. التطوير والصيانة

### 8.1 متطلبات التطوير
- Node.js و npm
- أدوات التطوير (ESLint, Prettier)
- بيئة اختبار محلية

### 8.2 عملية النشر
- فحص الإصدار
- نسخ احتياطي للبيانات
- تحديث المكتبات
- اختبار الأداء

### 8.3 المراقبة
- تسجيل الأخطاء
- مراقبة الأداء
- تتبع الاستخدام
- تنبيهات الأمان 